image: python:3.13-alpine

stages:
  - lint
  - test

# Global variables
variables:
  PIP_CACHE_DIR: "/cache/pip/$CI_PROJECT_PATH_SLUG-$CI_COMMIT_REF_SLUG"
  #PIP_NO_CACHE_DIR: "false"  # Use cache for pip
  PYTHONDONTWRITEBYTECODE: "1"  # Don't create .pyc files
  PYTHONUNBUFFERED: "1"  # Force stdout/stderr to be unbuffered

# Retry configuration for network issues
.retry_config: &retry_config
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
      - api_failure

# Base configuration for lint jobs
.lint_base:
  stage: lint
  <<: *retry_config
  before_script:
    - pip install --upgrade pip setuptools wheel

# Check code formatting with Ruff
ruff-format-job:
  extends: .lint_base
  script:
    - pip install ruff>=0.8.0
    - ruff format --check --diff pysdl/ examples/ tests/
  allow_failure: false

# Run linting with Ruff
ruff-lint-job:
  extends: .lint_base
  script:
    - pip install ruff>=0.8.0
    - ruff check pysdl/ examples/ tests/
  allow_failure: false

# Run type checking with mypy
mypy-type-check-job:
  extends: .lint_base
  script:
    - pip install mypy==1.13.0
    - mypy pysdl/ examples/ --ignore-missing-imports
  allow_failure: false

# Run pytest with coverage
pytest-job:
  stage: test
  <<: *retry_config
  before_script:
    - apk add --virtual .build-deps g++ && apk del .build-deps || true
    - pip install --upgrade pip setuptools wheel
    - pip install -e ".[dev]"
  script:
    - export PYTHONPATH=$PYTHONPATH:$(pwd)
    - pytest --cov=pysdl --cov-report=term --cov-report=xml --cov-report=html --tb=short -v
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'
  artifacts:
    when: always
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
      junit: junit.xml
    paths:
      - htmlcov/
      - coverage.xml
      - junit.xml
    expire_in: 30 days
  dependencies: []
